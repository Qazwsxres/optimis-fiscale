<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Optimis Fiscale</title>
  <style>
    :root{
      --bg:#0b1020;--card:#11172c;--muted:#a3adbf;--line:#243155;
      --accent:#3a71ff;--text:#e6e9ef;--ok:#2ecc71;--err:#e74c3c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif
    }
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    h1{font-size:22px;margin:0}
    .sub{color:var(--muted);font-size:14px;margin-top:4px}
    .card{
      background:var(--card);border:1px solid var(--line);
      border-radius:16px;padding:16px;box-shadow:0 12px 28px rgba(0,0,0,.25)
    }
    .controls{display:grid;gap:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{
      background:#0e1428;border:1px solid var(--line);
      border-radius:12px;padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    .btn,.btn-secondary{
      display:inline-flex;align-items:center;gap:8px;
      padding:12px 16px;border-radius:12px;
      font-weight:600;cursor:pointer;border:1px solid transparent
    }
    .btn{background:var(--accent);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:#0e1428;color:var(--text);border-color:var(--line)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .status{font-size:13px;color:var(--muted)}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--err)}
    .tiles{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:14px}
    .tile{background:#0e1428;border:1px solid var(--line);border-radius:14px;padding:14px}
    footer{margin-top:16px;color:var(--muted);font-size:13px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:100}
    .modal{width:min(560px,92vw);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .gear{
      background:#0e1428;border:1px solid var(--line);
      width:40px;height:40px;display:grid;place-items:center;
      border-radius:12px;cursor:pointer
    }
    #authbar{display:flex;gap:8px;align-items:center}
    #authbar .user-tag{font-size:13px;color:#a3adbf}

    /* chat widget */
    #chat-btn{position:fixed;right:20px;bottom:20px;z-index:30}
    #chat-btn button{
      background:#3a71ff;color:#fff;border:0;
      padding:14px 16px;border-radius:999px;
      font-weight:700;cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,.35)
    }
    #chat-box{
      position:fixed;right:20px;bottom:80px;
      width:min(380px,92vw);background:#11172c;
      border:1px solid #243155;border-radius:16px;
      overflow:hidden;display:none;z-index:30
    }
    #chat-head{
      padding:12px 14px;font-weight:700;
      border-bottom:1px solid #243155;
      display:flex;justify-content:space-between;align-items:center
    }
    #chat-head img{
      width:28px;height:28px;border-radius:50%;
      border:1px solid #243155
    }
    #chat-log{
      height:280px;overflow:auto;padding:12px;
      display:flex;flex-direction:column;gap:10px
    }
    .msg{
      padding:10px 12px;border-radius:12px;
      max-width:85%;font-size:14px;line-height:1.35
    }
    .me{background:#3a71ff;color:#fff;align-self:flex-end}
    .bot{background:#0e1428;border:1px solid #243155;color:#e6e9ef;align-self:flex-start}
    #chat-input{
      display:flex;gap:8px;padding:10px;
      border-top:1px solid #243155;background:#0e1428
    }
    #chat-input input{
      flex:1;background:#0e1428;border:1px solid #33416d;
      color:#e6e9ef;border-radius:10px;padding:10px
    }
    #chat-input button{
      background:#3a71ff;color:#fff;border:0;
      padding:10px 14px;border-radius:10px;
      font-weight:700;cursor:pointer
    }

    .spinner{display:none;gap:8px;align-items:center}
    .spinner.active{display:inline-flex}
    .spinner .dot{
      width:8px;height:8px;border-radius:50%;
      background:#3a71ff;animation:b 1s infinite
    }
    .spinner .dot:nth-child(2){animation-delay:.15s}
    .spinner .dot:nth-child(3){animation-delay:.3s}
    @keyframes b{
      0%,80%,100%{opacity:.2;transform:scale(.9)}
      40%{opacity:1;transform:scale(1)}
    }
    #csvPreview{display:none;margin-top:8px}
    #csvPreview table{width:100%;border-collapse:collapse;border:1px solid var(--line)}
    #csvPreview th,#csvPreview td{border:1px solid var(--line);padding:6px;font-size:13px}
    #csvPreview th{color:#c6d0f5;background:#0f1530}

    .hint-import{
      margin-top:6px;font-size:11px;
      color:var(--muted);line-height:1.4
    }

    @media print{
      #chat-btn,#chat-box,header,.controls,.modal-backdrop{display:none!important}
      body{background:#fff;color:#000}
      .card{border:0;box-shadow:none}
    }
    @media (max-width:960px){
      .grid2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Optimis Fiscale</h1>
      <div class="sub" id="headerSub">Analyse de balance & estimation fiscale (FR)</div>
    </div>
    <div class="row" id="authbar">
      <div class="gear" id="openSettings" title="Paramètres (API)">⚙️</div>
      <a class="btn-secondary" href="https://optimis-fiscale-production.up.railway.app/docs" target="_blank">API Docs</a>
      <button id="loginBtn" class="btn-secondary">Se connecter</button>
      <span id="who" class="user-tag" style="display:none"></span>
      <button id="logoutBtn" class="btn-secondary" style="display:none">Se déconnecter</button>
    </div>
  </header>

  <div class="row" style="margin:8px 0;gap:8px">
    <button class="btn-secondary" id="exportBtn">Exporter (PDF)</button>
    <button class="btn-secondary" id="privacyBtn">Confidentialité</button>
    <span class="spinner" id="globalSpin">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </span>
  </div>

  <div class="card">
    <div class="controls">
      <div class="grid2">
        <div class="field">
          <div>
            <strong>Fichier CSV</strong><br>
            <span class="hint">Colonnes : <code>account,label,debit,credit</code></span>
          </div>
          <div class="row">
            <input id="csvInput" type="file" accept=".csv" style="display:none" />
            <label class="btn-secondary" for="csvInput" style="cursor:pointer;">Choisir un fichier</label>
            <span id="fileName" class="badge" style="display:none"></span>
          </div>
        </div>
        <div class="field">
          <div>
            <strong>Chiffre d'affaires (optionnel)</strong><br>
            <span class="hint">Pour affiner les ratios</span>
          </div>
          <input id="turnover" type="number" step="0.01" placeholder="Ex : 100000" />
        </div>
        <div class="field">
          <div>
            <strong>Référentiel d’audit</strong><br>
            <span class="hint">Choisir IFRS ou US GAAP</span>
          </div>
          <select id="framework"
            style="background:#0e1428;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:8px 10px;">
            <option value="IFRS" selected>IFRS</option>
            <option value="USGAAP">US GAAP</option>
          </select>
        </div>
      </div>

      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="analyzeBtn" class="btn">Analyser</button>
          <button id="auditBtn" class="btn-secondary">Test Audit</button>
          <button id="optimizeBtn" class="btn-secondary">Optimisation fiscale</button>
        </div>
        <div class="status" id="status">Prêt</div>
      </div>
    </div>

    <div id="csvPreview" class="tile">
      <h3>Aperçu CSV (10 premières lignes)</h3>
      <div id="csvTableWrap"></div>
    </div>

    <div id="results" style="display:none;margin-top:10px">
      <div class="tiles">
        <div class="tile"><h3>KPIs</h3><div class="kv" id="kpi"></div></div>
        <div class="tile"><h3>Fiscalité</h3><div class="kv" id="tax"></div></div>
      </div>
      <div class="tiles" style="margin-top:12px">
        <div class="tile"><h3>Audit — Résumé</h3><div class="kv" id="auditSummary"></div></div>
        <div class="tile"><h3>Audit — Points relevés</h3><ul id="auditIssues" style="margin:0;padding-left:18px"></ul></div>
      </div>
      <div class="tile" style="margin-top:12px">
        <h3>Top comptes (par solde absolu)</h3>
        <div id="auditTop"></div>
      </div>

      <div class="tile" style="margin-top:12px">
        <h3>Optimisation fiscale — Recommandations</h3>
        <div id="optimizeOut" style="white-space:pre-wrap"></div>
      </div>
    </div>
  </div>

  <!-- ====== IMPORTATION + SUIVI en grille responsive ====== -->
  <div class="grid2" style="margin-top:20px;align-items:flex-start;">
    <!-- Importation des fichiers -->
    <div class="card">
      <h2 id="importSectionTitle">Importation des fichiers</h2>

      <div class="field" style="display:block;">
        <strong>Relevé bancaire (.csv)</strong>
        <input type="file" id="bankFile" accept=".csv"
          style="margin-top:8px;width:100%;padding:10px;background:#0e1428;border:1px solid var(--line);color:#e6e9ef;border-radius:10px;">
        <button class="btn" id="uploadBankBtn" style="margin-top:8px;">Importer relevé</button>
        <div id="bankUploadStatus" class="status"></div>
        <div class="hint-import">
          Format attendu : CSV avec au moins les colonnes
          <code>date</code>, <code>label</code>, <code>amount</code> (ou <code>montant</code>).<br>
          Séparateur <code>;</code> ou <code>,</code>.
        </div>
      </div>

      <div class="field" style="display:block;margin-top:12px;">
        <strong>Factures de ventes (.csv / .xlsx)</strong>
        <input type="file" id="salesFile" accept=".csv,.xlsx"
          style="margin-top:8px;width:100%;padding:10px;background:#0e1428;border:1px solid var(--line);color:#e6e9ef;border-radius:10px;">
        <button class="btn-secondary" id="uploadSalesBtn" style="margin-top:8px;">Importer ventes</button>
        <div id="salesUploadStatus" class="status"></div>
        <div class="hint-import">
          CSV recommandé avec colonnes :
          <code>number</code> (ou <code>invoice_number</code>),
          <code>date</code> (ou <code>issue_date</code>),
          <code>due_date</code>,
          <code>amount</code> (ou <code>total</code>),
          <code>status</code> (optionnel).
        </div>
      </div>

      <div class="field" style="display:block;margin-top:12px;">
        <strong>Factures d’achats (.csv / .xlsx)</strong>
        <input type="file" id="purchasesFile" accept=".csv,.xlsx"
          style="margin-top:8px;width:100%;padding:10px;background:#0e1428;border:1px solid var(--line);color:#e6e9ef;border-radius:10px;">
        <button class="btn-secondary" id="uploadPurchasesBtn" style="margin-top:8px;">Importer achats</button>
        <div id="purchasesUploadStatus" class="status"></div>
        <div class="hint-import">
          CSV recommandé avec colonnes :
          <code>number</code> (ou <code>invoice_number</code>),
          <code>date</code> (ou <code>issue_date</code>),
          <code>due_date</code>,
          <code>amount</code> (ou <code>total</code>),
          <code>status</code> (optionnel).
        </div>
      </div>
    </div>

    <!-- Suivi Trésorerie & Facturation -->
    <div class="card">
      <h2 id="bankMainTitle">Suivi Trésorerie &amp; Facturation</h2>
      <div id="bankSummary" class="tiles">
        <div class="tile"><h3>Solde bancaire</h3><div id="bankBalance">—</div></div>
        <div class="tile"><h3>Entrées</h3><div id="bankInflows">—</div></div>
        <div class="tile"><h3>Sorties</h3><div id="bankOutflows">—</div></div>
      </div>
      <div style="margin-top:16px">
        <h3 id="cashChartTitle">Évolution du solde</h3>
        <canvas id="cashChart" height="100"></canvas>
      </div>
      <div class="tiles" style="margin-top:20px">
        <div class="tile">
          <h3 id="salesTableTitle">Factures ventes</h3>
          <table id="salesTable" style="width:100%;font-size:13px">
            <thead><tr><th>#</th><th>Date</th><th>Échéance</th><th>Montant</th><th>Statut</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tile">
          <h3 id="purchasesTableTitle">Factures achats</h3>
          <table id="purchasesTable" style="width:100%;font-size:13px">
            <thead><tr><th>#</th><th>Date</th><th>Échéance</th><th>Montant</th><th>Statut</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="tile" style="margin-top:20px">
        <h3 id="alertsTitle">Alertes fiscales &amp; paiements</h3>
        <ul id="alertsList" style="margin:0;padding-left:18px"></ul>
      </div>
    </div>
  </div>

  <footer id="footerText">© 2025 Optimis Fiscale — Les fichiers ne sont jamais stockés.</footer>
</div>

<!-- Privacy Modal -->
<div class="modal-backdrop" id="privacyModal" style="display:none">
  <div class="modal">
    <h2 id="privacyTitle">Confidentialité</h2>
    <p id="privacyBody">
      Les fichiers sont traités en mémoire côté serveur uniquement pendant l’analyse.
      Aucune donnée n’est stockée ni réutilisée. Le chatbot ne garde aucun historique.
    </p>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="closePrivacy">Fermer</button>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div class="modal-backdrop" id="loginModal" style="display:none">
  <div class="modal">
    <h2 id="loginTitle">Connexion</h2>
    <div class="field" style="margin-top:8px;display:block;">
      <label id="loginCompanyLabel"><strong>Identifiant entreprise</strong></label>
      <input id="companyId" type="text" placeholder="ex: demo"
        style="width:100%;margin-top:8px;padding:10px;border-radius:10px;background:#0e1428;border:1px solid var(--line);color:#e6e9ef;" />
    </div>
    <div class="field" style="margin-top:8px;display:block;">
      <label id="loginPwdLabel"><strong>Mot de passe</strong></label>
      <input id="companyPwd" type="password" placeholder="••••••••"
        style="width:100%;margin-top:8px;padding:10px;border-radius:10px;background:#0e1428;border:1px solid var(--line);color:#e6e9ef;" />
    </div>
    <div class="row" style="margin-top:12px;justify-content:flex-end;">
      <button class="btn-secondary" id="cancelLogin">Annuler</button>
      <button class="btn" id="doLogin">Connexion</button>
    </div>
  </div>
</div>

<!-- Chat -->
<div id="chat-btn"><button id="openChatBtn">Chat</button></div>
<div id="chat-box">
  <div id="chat-head">
    <div class="name" style="display:flex;gap:8px;align-items:center">
      <img src="https://via.placeholder.com/56x56.png?text=A" alt="Albert">
      <span id="chatHeaderTitle">Albert — Assistant Fiscal</span>
    </div>
    <button id="closeChatBtn" class="btn-secondary" style="padding:6px 10px;border-radius:10px">Fermer</button>
  </div>
  <div id="chat-log"></div>
  <div id="chat-input">
    <input id="chatText" type="text" placeholder="Posez votre question…" />
    <button id="sendChat">Envoyer</button>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const $ = id => document.getElementById(id);
const euro = v => (typeof v === 'number' && isFinite(v))
  ? v.toLocaleString(undefined,{style:'currency',currency:'EUR'})
  : '—';
const pct = v => (v ?? v === 0)
  ? (Number(v).toLocaleString(undefined,{maximumFractionDigits:2})+'%')
  : '—';

/* Textes FR */
const STRINGS = {
  statusReady: "Prêt",
  genericError: "Erreur",
  chooseCsv: "Veuillez choisir un CSV",
  analyzeRunning: "Analyse en cours…",
  analyzeDone: "Analyse terminée",
  auditRunning: "Audit en cours…",
  auditDone: "Audit terminé",
  optimizeRunning: "Analyse pour optimisation…",
  optimizeDone: "Optimisation (locale) prête",
  optimizeErrorPrefix: "Erreur : ",
  loginMissing: "Identifiant et mot de passe requis",
  loginRunning: "Connexion…",
  loginOk: "Connecté",
  logoutStatus: "Déconnecté",
  chatNeedLogin: "Veuillez vous connecter pour utiliser le chat",
  chatThinking: "Albert réfléchit…",
  chatSessionExpired: "Session expirée. Veuillez vous reconnecter.",
  chatErrorStatus: "Erreur chat",
  uploadErrPrefix: "❌ Erreur : ",
  uploadChooseFile: "Veuillez choisir un fichier",
  uploadRunning: "Importation en cours…",
  uploadOk: "✅ Importation réussie",
  uploadNetworkErrPrefix: "❌ ",
  uploadNetworkErrorFallback: "Erreur réseau",
  chartDailyLabel: "Solde bancaire quotidien",
  chartFallbackLabel: "Flux bancaires",
  noInvoices: "Aucune facture",
  alertsEmpty: "Aucune alerte active",
  alertsLoadError: "Erreur de chargement des données"
};

// Always HTTPS API
const DEFAULT_API = "https://optimis-fiscale-production.up.railway.app";

const getApiBase = () => DEFAULT_API;
const setStatus = (m,k) => {
  const e = $('status');
  if(e){ e.textContent = m; e.className = 'status' + (k ? ' '+k : ''); }
};
const spin = s => $('globalSpin')?.classList.toggle('active', !!s);

/* privacy */
$('exportBtn').onclick = () => window.print();
$('privacyBtn').onclick = () => $('privacyModal').style.display = 'grid';
$('closePrivacy').onclick = () => $('privacyModal').style.display = 'none';
$('privacyModal').addEventListener('click',e=>{
  if(e.target===e.currentTarget)e.currentTarget.style.display='none';
});

/* CSV preview */
$('csvInput').addEventListener('change', () => {
  const f = $('csvInput').files?.[0];
  if (!f){
    $('csvPreview').style.display='none';
    return;
  }
  $('fileName').style.display='inline-block';
  $('fileName').textContent=f.name;
  const r = new FileReader();
  r.onload = () => {
    const t = String(r.result||'');
    const rows = t.trim().split(/\r?\n/).slice(0,11)
      .map(x=>x.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/));
    if(rows.length){
      $('csvPreview').style.display='block';
      $('csvTableWrap').innerHTML =
        `<table><thead>${rows[0].map(h=>`<th>${h}</th>`).join('')}</thead>
         <tbody>${rows.slice(1).map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
    }
  };
  r.readAsText(f);
});

/* Analyze */
async function runAnalyze(){
  const t = STRINGS;
  const base=getApiBase(); const file=$('csvInput').files?.[0]; const tv=$('turnover').value;
  if(!file){ setStatus(t.chooseCsv,'err'); return; }
  const fd=new FormData(); fd.append('file',file); if(tv) fd.append('turnover',tv);
  spin(true); setStatus(t.analyzeRunning); $('analyzeBtn').disabled=true;
  try{
    const r=await fetch(base+'/analyze/trial-balance',{method:'POST',body:fd,credentials:'include'});
    const d=await r.json(); if(!r.ok) throw new Error(d?.detail||t.genericError);
    $('results').style.display='block';
    const k=d.kpi||{},tx=d.tax||{};
    $('kpi').innerHTML=`<div><span>CA</span><strong>${euro(k.revenue)}</strong></div>
      <div><span>Marge brute</span><strong>${euro(k.gross_margin)}</strong></div>
      <div><span>EBITDA</span><strong>${euro(k.ebitda_approx)} (${pct(k.ebitda_margin_pct)})</strong></div>
      <div><span>Résultat net</span><strong>${euro(k.net_result)}</strong></div>`;
    $('tax').innerHTML=`<div><span>IS estimé</span><strong>${euro(tx.corporate_income_tax)}</strong></div>
      <div><span>TVA nette</span><strong>${euro(tx.vat_balance)}</strong></div>`;
    setStatus(t.analyzeDone,'ok');
  }catch(e){ setStatus(e.message||t.genericError,'err'); }
  finally{ spin(false); $('analyzeBtn').disabled=false; }
}
$('analyzeBtn').onclick=runAnalyze;

/* Audit */
async function runAudit(){
  const t = STRINGS;
  const base=getApiBase(); const f=$('csvInput').files?.[0]; const fw=$('framework').value;
  if(!f){ setStatus(t.chooseCsv,'err'); return; }
  const fd=new FormData(); fd.append('file',f); fd.append('standard',fw);
  spin(true); setStatus(t.auditRunning); $('auditBtn').disabled=true;
  try{
    const r=await fetch(base+'/audit/test',{method:'POST',body:fd,credentials:'include'});
    const d=await r.json(); if(!r.ok) throw new Error(d?.detail||t.genericError);
    $('results').style.display='block';
    const s=d.summary||{}; const issues=d.issues||[]; const top=d.top_accounts||[];
    $('auditSummary').innerHTML=`<div>Total lignes: <strong>${s.total_rows}</strong></div>
      <div>Débits: <strong>${euro(s.total_debit)}</strong></div>
      <div>Crédits: <strong>${euro(s.total_credit)}</strong></div>
      <div>Écart: <strong>${euro(s.imbalance)}</strong></div>
      <div>Référentiel: <strong>${s.framework}</strong></div>`;
    $('auditIssues').innerHTML = issues.map(i=>{
      const sev = (i.severity || '').toString().toUpperCase();
      return `<li><strong>[${sev}]</strong> ${i.message || ''}${i.count?' ('+i.count+')':''}</li>`;
    }).join('');
    $('auditTop').innerHTML=`<table><thead><tr><th>Compte</th><th>Libellé</th><th>Solde</th><th>Absolu</th></tr></thead>
      <tbody>${top.map(tl=>`<tr><td>${tl.account}</td><td>${tl.label}</td><td>${euro(tl.balance)}</td><td>${euro(tl.abs_balance)}</td></tr>`).join('')}</tbody></table>`;
    setStatus(t.auditDone,'ok');
  }catch(e){ setStatus(e.message||t.genericError,'err'); }
  finally{ spin(false); $('auditBtn').disabled=false; }
}
$('auditBtn').onclick=runAudit;

/* Optimisation fiscale locale (sans /chat) */
function localOptimizeFromKPIs(kpi, tax){
  const out = [];
  const rev = +kpi.revenue || 0;
  const gm  = +kpi.gross_margin || 0;
  const ebitda = +kpi.ebitda_approx || 0;
  const ebitdaPct = +kpi.ebitda_margin_pct || 0;
  const net = +kpi.net_result || 0;
  const vat = +(tax?.vat_balance ?? 0);

  if ((rev>0) && (gm/(rev||1) < 0.30))
    out.push("Marge brute faible: renégocier achats, optimiser transport refacturable, revoir stocks et démarques.");
  if (ebitdaPct < 10)
    out.push("Déductibilité des charges: abonnements, télécoms, assurances. Vérifier CAPEX vs OPEX pour amortir.");
  if (ebitda > 0)
    out.push("Optimiser les plans d’amortissement (composants, durées). Étudier le dégressif si applicable.");
  if (net < 0)
    out.push("Examiner report en avant des déficits et, si pertinent, report en arrière (carry-back).");
  out.push("Qualifier des travaux R&D/innovation pour CIR/CII (documentation, temps passés, sous-traitance éligible).");
  out.push("Vérifier l’éligibilité JEI/JEU, exonérations locales et aides régionales selon votre profil.");
  if (vat > 0)
    out.push("TVA collectée > déductible: adapter régime et sécuriser récupération sur immobilisations et frais.");
  if (vat < 0)
    out.push("Crédit de TVA récurrent: demandes de remboursement périodiques, vérifier déduction des factures.");
  if (net > 0 && ebitdaPct > 8)
    out.push("Arbitrer rémunération vs dividendes vs intéressement pour optimiser charges (IS/IR/cotisations).");
  out.push("Revoir provisions (clients douteux, stocks) et CCA/PCA pour lisser le résultat sans risque.");
  out.push("Si intragroupe: documenter refacturations et prix de transfert pour réduire le risque de redressement.");
  out.push("Vérifier l’éligibilité au taux réduit PME sur la fraction du bénéfice concernée, si conditions réunies.");
  return out;
}
async function runOptimize(){
  const t = STRINGS;
  const base = getApiBase();
  const file = $('csvInput').files?.[0];
  const tv = $('turnover')?.value;
  if(!file){ setStatus(t.chooseCsv,'err'); return; }
  const fd = new FormData(); fd.append('file', file); if (tv) fd.append('turnover', tv);
  spin(true); setStatus(t.optimizeRunning); $('optimizeBtn').disabled = true;
  try{
    const r = await fetch(base + '/analyze/trial-balance', { method: 'POST', body: fd, credentials:'include' });
    const analysis = await r.json();
    if (!r.ok) throw new Error(analysis?.detail || t.genericError);
    $('results').style.display='block';
    const k = analysis.kpi || {}; const tax = analysis.tax || {};
    const items = localOptimizeFromKPIs(k, tax);
    $('optimizeOut').innerHTML = `<ul>${items.map(x=>`<li>${x}</li>`).join('')}</ul>
      <div style="margin-top:8px;font-size:12px;color:#a3adbf">
        Note: recommandations indicatives à confirmer selon votre situation et la réglementation.
      </div>`;
    setStatus(t.optimizeDone,'ok');
  }catch(e){
    setStatus(e.message || t.genericError,'err');
    $('optimizeOut').textContent = (t.optimizeErrorPrefix || "Erreur : ") + (e.message || '');
  }finally{
    $('optimizeBtn').disabled = false; spin(false);
  }
}
$('optimizeBtn').onclick = runOptimize;

/* Login modal */
function openLogin(){ $('loginModal').style.display='grid'; }
function closeLogin(){ $('loginModal').style.display='none'; }

/* Auth */
$('loginBtn').onclick = openLogin;
$('cancelLogin').onclick = closeLogin;
$('doLogin').onclick = async () => {
  const t = STRINGS;
  const base = getApiBase();
  const company_id = $('companyId').value.trim();
  const password = $('companyPwd').value;
  if(!company_id || !password){
    setStatus(t.loginMissing,'err');
    return;
  }
  try{
    spin(true); setStatus(t.loginRunning);
    const r = await fetch(base+'/auth/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ company_id, password })
    });
    const d = await r.json();
    if(!r.ok) throw new Error(d?.detail || t.genericError);
    closeLogin();
    $('who').style.display='inline-block';
    $('who').textContent = `Connecté: ${d.company_id}`;
    $('loginBtn').style.display='inline-flex';
    $('loginBtn').style.display='none';
    $('logoutBtn').style.display='inline-flex';
    setStatus(t.loginOk,'ok');
  }catch(e){
    setStatus(e.message || t.genericError,'err');
  }finally{
    spin(false);
  }
};
$('logoutBtn').onclick = async () => {
  const t = STRINGS;
  const base = getApiBase();
  try{
    spin(true);
    await fetch(base+'/auth/logout', { method:'POST', credentials:'include' });
  }finally{
    $('who').style.display='none'; $('who').textContent='';
    $('loginBtn').style.display='inline-flex';
    $('logoutBtn').style.display='none';
    setStatus(t.logoutStatus);
    spin(false);
  }
};

/* Chat */
const chatBox = $('chat-box');
const chatLog = $('chat-log');
const chatText = $('chatText');
const appendMsg = (role, text) => {
  const div = document.createElement('div');
  div.className = 'msg ' + (role === 'user' ? 'me' : 'bot');
  div.textContent = text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
};
const isLoggedIn = () => $('logoutBtn').style.display !== 'none';
$('openChatBtn').onclick = () => {
  const t = STRINGS;
  if (!isLoggedIn()) {
    setStatus(t.chatNeedLogin,'err');
    openLogin();
    return;
  }
  chatBox.style.display = 'block';
  chatText.focus();
};
$('closeChatBtn').onclick = () => chatBox.style.display = 'none';
$('sendChat').onclick = sendChat;
chatText.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendChat(); });
async function sendChat(){
  const t = STRINGS;
  const base = getApiBase(); const text = chatText.value.trim();
  if (!text) return;
  appendMsg('user', text);
  chatText.value = '';
  setStatus(t.chatThinking);
  try{
    const r = await fetch(base + '/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ messages: [{ role: 'user', content: text }] })
    });
    if (r.status === 401) {
      setStatus(t.chatSessionExpired,'err');
      openLogin();
      return;
    }
    const d = await r.json();
    if (!r.ok) throw new Error(d?.detail || t.genericError);
    appendMsg('assistant', d.reply || '(réponse vide)');
    setStatus(t.statusReady);
  }catch(e){
    appendMsg('assistant', (t.uploadErrPrefix || "❌ ") + (e.message || t.chatErrorStatus));
    setStatus(t.chatErrorStatus,'err');
  }
}

/* Importation des fichiers */
async function uploadFile(inputId, endpoint, statusId){
  const t = STRINGS;
  const file = $(inputId).files?.[0];
  const status = $(statusId);
  if(!file){
    status.textContent=t.uploadChooseFile;
    status.className="status err";
    return;
  }
  const fd=new FormData();fd.append("file",file);
  try{
    spin(true);
    status.textContent=t.uploadRunning;
    status.className="status";
    const r=await fetch(getApiBase()+endpoint,{method:'POST',body:fd,credentials:'include'});
    if(r.ok){
      status.textContent=t.uploadOk;
      status.className="status ok";
      await loadDashboard();
    }else{
      const err=await r.text();
      status.textContent=(t.uploadErrPrefix || "❌ Erreur : ")+err.slice(0,150);
      status.className="status err";
    }
  }catch(e){
    status.textContent=(t.uploadNetworkErrPrefix || "❌ ")+(e.message||t.uploadNetworkErrorFallback);
    status.className="status err";
  }finally{
    spin(false);
  }
}
$('uploadBankBtn').onclick=()=>uploadGeneric('bankFile','/bank/upload','bankUploadStatus');
$('uploadSalesBtn').onclick=()=>uploadGeneric('salesFile','/invoices/sales','salesUploadStatus');
$('uploadPurchasesBtn').onclick=()=>uploadGeneric('purchasesFile','/invoices/purchases','purchasesUploadStatus');
function uploadGeneric(fileId, endpoint, statusId){
  uploadFile(fileId, endpoint, statusId);
}

/* Dashboard loader with daily cashflow */
let cashChartInstance = null;

async function loadDashboard(){
  const apiBase = getApiBase();
  const t = STRINGS;
  try{
    const [bank,sales,purchases,alerts,cashflow] = await Promise.all([
      fetch(apiBase+'/bank/summary',{credentials:'include'}).then(r=>r.json()),
      fetch(apiBase+'/invoices/sales',{credentials:'include'}).then(r=>r.json()),
      fetch(apiBase+'/invoices/purchases',{credentials:'include'}).then(r=>r.json()),
      fetch(apiBase+'/alerts',{credentials:'include'}).then(r=>r.json()),
      fetch(apiBase+'/bank/cashflow',{credentials:'include'}).then(r=>r.json())
    ]);

    // Bank summary tiles
    $('bankBalance').textContent=(bank.balance??0).toLocaleString(
      undefined,{style:'currency',currency:'EUR'}
    );
    $('bankInflows').textContent=(bank.inflows??0).toLocaleString(
      undefined,{style:'currency',currency:'EUR'}
    );
    $('bankOutflows').textContent=(bank.outflows??0).toLocaleString(
      undefined,{style:'currency',currency:'EUR'}
    );

    // Daily cashflow chart
    const ctx=$('cashChart');

    let labels, dataPoints, datasetLabel;
    if (Array.isArray(cashflow) && cashflow.length){
      labels = cashflow.map(p => p.date);
      dataPoints = cashflow.map(p => p.balance);
      datasetLabel = t.chartDailyLabel;
    } else {
      labels = ['Entrées','Sorties','Solde'];
      dataPoints = [
        bank.inflows || 0,
        Math.abs(bank.outflows || 0),
        bank.balance || 0
      ];
      datasetLabel = t.chartFallbackLabel;
    }

    if (cashChartInstance) {
      cashChartInstance.destroy();
    }

    cashChartInstance = new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[{
          label:datasetLabel,
          data:dataPoints,
          borderColor:'#3a71ff',
          backgroundColor:'rgba(58,113,255,0.2)',
          tension:0.3
        }]
      },
      options:{
        plugins:{legend:{display:false}},
        scales:{
          x:{ticks:{color:'#a3adbf'}},
          y:{ticks:{color:'#a3adbf'}}
        }
      }
    });

    const noInvoicesText = t.noInvoices;
    const alertsEmptyText = t.alertsEmpty;

    const row=x=>`<tr>
      <td>${x.number||'-'}</td>
      <td>${x.issue_date||'-'}</td>
      <td>${x.due_date||'-'}</td>
      <td>${(x.amount||0).toLocaleString()} €</td>
      <td>${x.status||'-'}</td>
    </tr>`;

    $('salesTable').querySelector('tbody').innerHTML =
      (Array.isArray(sales)&&sales.length)
        ? sales.map(row).join('')
        : `<tr><td colspan="5">${noInvoicesText}</td></tr>`;

    $('purchasesTable').querySelector('tbody').innerHTML =
      (Array.isArray(purchases)&&purchases.length)
        ? purchases.map(row).join('')
        : `<tr><td colspan="5">${noInvoicesText}</td></tr>`;

    $('alertsList').innerHTML =
      (Array.isArray(alerts)&&alerts.length)
        ? alerts.map(a=>`<li>${a.message||'Alerte'} — <span style="color:#a3adbf">${a.due_date||''}</span></li>`).join('')

        : `<li>${alertsEmptyText}</li>`;
  }catch(e){
    console.error(e);
    $('alertsList').innerHTML = `<li>${STRINGS.alertsLoadError}</li>`;
  }
}

/* init */
document.addEventListener('DOMContentLoaded', () => {
  setStatus(STRINGS.statusReady);
  loadDashboard();
});
</script>
</body>
</html>
