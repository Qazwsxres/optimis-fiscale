<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Optimis Fiscale</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #11172c;
      --muted: #a3adbf;
      --line: #243155;
      --accent: #3a71ff;
      --text: #e6e9ef;
      --ok: #2ecc71;
      --err: #e74c3c;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    h1 { font-size: 22px; margin: 0; }
    .sub { color: var(--muted); font-size: 14px; margin-top: 4px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 16px; box-shadow: 0 12px 28px rgba(0,0,0,.25); }
    .controls { display:grid; gap:12px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .field { background:#0e1428; border:1px solid var(--line); border-radius:12px; padding: 12px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .field label { font-size:14px; color:var(--muted); }
    input[type="number"] { width: 180px; background:#0e1428; border:1px solid var(--line); color:var(--text); border-radius: 10px; padding:8px 10px; }
    input[type="file"] { display:none; }
    .btn, .btn-secondary { display:inline-flex; align-items:center; gap:8px; padding: 12px 16px; border-radius: 12px; font-weight:600; cursor:pointer; border:1px solid transparent; }
    .btn { background:var(--accent); color:white; }
    .btn:disabled { opacity: .6; cursor:not-allowed; }
    .btn-secondary { background:#0e1428; color:var(--text); border-color:var(--line); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .status { font-size: 13px; color:var(--muted); }
    .status.ok { color: var(--ok); } .status.err { color: var(--err); }
    .tiles { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; margin-top: 14px; }
    .tile { background:#0e1428; border:1px solid var(--line); border-radius:14px; padding:14px; }
    .tile h3 { margin:0 0 8px; font-size:16px; color:#c6d0f5; }
    .kv { display:grid; gap:6px; font-size:14px; }
    .kv div { display:flex; justify-content:space-between; gap:8px; }
    .badge { display:inline-block; padding:4px 8px; border:1px solid var(--line); border-radius:999px; color:#c6d0f5; font-size:12px; }
    details { margin-top:10px; }
    pre { background:#0e1428; border:1px solid var(--line); border-radius:12px; padding:12px; white-space:pre-wrap; word-break:break-word; font-size: 13px; }
    footer { margin-top:16px; color:var(--muted); font-size:13px; }

    /* settings modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; place-items:center; }
    .modal { width:min(560px, 92vw); background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; }
    .modal h2 { margin:0 0 8px; font-size:18px; }
    .modal .row { justify-content:space-between; }
    .gear { background:#0e1428; border:1px solid var(--line); width:40px; height:40px; display:grid; place-items:center; border-radius:12px; cursor:pointer; }
    .hint { color: var(--muted); font-size: 12px; }

    /* Auth bar */
    #authbar { display:flex; gap:8px; align-items:center; }
    #authbar .me { font-size:13px; color:#a3adbf; }

    /* Chat widget */
    #chat-btn { position: fixed; right: 20px; bottom: 20px; z-index: 30; }
    #chat-btn button { background:#3a71ff; color:#fff; border:0; padding:14px 16px; border-radius:999px; font-weight:700; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,.35); }
    #chat-box { position: fixed; right: 20px; bottom: 80px; width: min(380px, 92vw); background:#11172c; border:1px solid #243155; border-radius:16px; overflow:hidden; display:none; z-index:30; }
    #chat-head { padding:12px 14px; font-weight:700; border-bottom:1px solid #243155; display:flex; justify-content:space-between; align-items:center; }
    #chat-head .name { display:flex; align-items:center; gap:10px; }
    #chat-head img { width:28px; height:28px; border-radius:50%; border:1px solid #243155; }
    #chat-log { height: 280px; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:10px; }
    .msg { padding:10px 12px; border-radius:12px; max-width: 85%; font-size:14px; line-height:1.35; }
    .me  { background:#3a71ff; color:#fff; align-self:flex-end; }
    .bot { background:#0e1428; border:1px solid #243155; color:#e6e9ef; align-self:flex-start; }
    #chat-input { display:flex; gap:8px; padding:10px; border-top:1px solid #243155; background:#0e1428; }
    #chat-input input { flex:1; background:#0e1428; border:1px solid #33416d; color:#e6e9ef; border-radius:10px; padding:10px; }
    #chat-input button { background:#3a71ff; color:#fff; border:0; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }

    @media (max-width:720px){ .grid2{ grid-template-columns: 1fr; } header{flex-direction:column; align-items:flex-start;} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Optimis Fiscale</h1>
        <div class="sub">Analyse de balance & estimation fiscale (FR)</div>
      </div>

      <!-- RIGHT SIDE OF HEADER -->
      <div class="row" id="authbar">
        <div class="gear" id="openSettings" title="Paramètres (API)">⚙️</div>
        <a class="btn-secondary" href="https://optimis-fiscale-production.up.railway.app/docs" target="_blank" rel="noreferrer">API Docs</a>
        <button id="loginBtn" class="btn-secondary">Se connecter</button>
        <span id="who" class="me" style="display:none"></span>
        <button id="logoutBtn" class="btn-secondary" style="display:none">Se déconnecter</button>
      </div>
    </header>

    <div class="card">
      <div class="controls">
        <div class="grid2">
          <div class="field">
            <div>
              <strong>Fichier CSV</strong><br>
              <span class="hint">Colonnes: <code>account,label,debit,credit</code></span>
            </div>
            <div class="row">
              <label class="btn-secondary" for="csvInput">Choisir un fichier</label>
              <input id="csvInput" type="file" accept=".csv" />
              <span id="fileName" class="badge" style="display:none"></span>
            </div>
          </div>

          <div class="field">
            <div>
              <strong>Chiffre d'affaires (optionnel)</strong><br>
              <span class="hint">Pour affiner les ratios</span>
            </div>
            <input id="turnover" type="number" step="0.01" placeholder="Ex: 100000" />
          </div>
        </div>

        <div class="row" style="justify-content:space-between;">
          <button id="analyzeBtn" class="btn">Analyser</button>
          <div class="status" id="status">Prêt</div>
        </div>
      </div>

      <div id="results" style="display:none; margin-top: 10px;">
        <div class="tiles">
          <div class="tile">
            <h3>KPIs</h3>
            <div class="kv" id="kpi"></div>
          </div>
          <div class="tile">
            <h3>Fiscalité</h3>
            <div class="kv" id="tax"></div>
          </div>
        </div>

        <div class="tile" style="margin-top:12px">
          <h3>Suggestions</h3>
          <ul id="suggs" style="margin:0; padding-left: 18px;"></ul>
        </div>

        <details class="tile" style="margin-top:12px">
          <summary>Advanced → Show details (JSON brut)</summary>
          <pre id="raw"></pre>
        </details>
      </div>
    </div>

    <footer>
      Astuce : si la page ne répond pas, vérifiez l’URL de l’API dans les paramètres (⚙️).
    </footer>
  </div>

  <!-- Settings Modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal">
      <h2>Paramètres</h2>
      <div class="field" style="margin-top:8px; display:block;">
        <label for="apiBase"><strong>API Base URL</strong></label>
        <input id="apiBase" type="text" style="width:100%; margin-top:8px; padding:10px; border-radius:10px; background:#0e1428; border:1px solid var(--line); color:var(--text);" value="https://optimis-fiscale-production.up.railway.app" />
        <div class="hint" style="margin-top:6px">Ex: https://optimis-fiscale-production.up.railway.app</div>
      </div>
      <div class="row" style="margin-top:12px; justify-content:flex-end;">
        <button class="btn-secondary" id="closeSettings">Annuler</button>
        <button class="btn" id="saveSettings">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Login Modal (MOVED OUT OF <style>) -->
  <div class="modal-backdrop" id="loginModal" style="display:none">
    <div class="modal">
      <h2>Connexion</h2>
      <div class="field" style="margin-top:8px; display:block;">
        <label><strong>Identifiant entreprise</strong></label>
        <input id="companyId" type="text" placeholder="ex: demo" style="width:100%; margin-top:8px; padding:10px; border-radius:10px; background:#0e1428; border:1px solid var(--line); color:var(--text);" />
      </div>
      <div class="field" style="margin-top:8px; display:block;">
        <label><strong>Mot de passe</strong></label>
        <input id="companyPwd" type="password" placeholder="••••••••" style="width:100%; margin-top:8px; padding:10px; border-radius:10px; background:#0e1428; border:1px solid var(--line); color:var(--text);" />
      </div>
      <div class="row" style="margin-top:12px; justify-content:flex-end;">
        <button class="btn-secondary" id="cancelLogin">Annuler</button>
        <button class="btn" id="doLogin">Connexion</button>
      </div>
    </div>
  </div>

  <!-- Chat widget HTML (MOVED OUT OF <script>) -->
  <div id="chat-btn"><button id="openChat">Chat</button></div>
  <div id="chat-box">
    <div id="chat-head">
      <div class="name">
        <img src="https://via.placeholder.com/56x56.png?text=A" alt="Albert">
        <span>Albert — Assistant Fiscal</span>
      </div>
      <button id="closeChat" class="btn-secondary" style="padding:6px 10px;border-radius:10px;">Fermer</button>
    </div>
    <div id="chat-log"></div>
    <div id="chat-input">
      <input id="chatText" type="text" placeholder="Posez votre question…" />
      <button id="sendChat">Envoyer</button>
    </div>
  </div>

  <script>
    // --- UI helpers ---
    const statusEl = document.getElementById('status');
    const showStatus = (msg, type) => {
      statusEl.textContent = msg;
      statusEl.className = 'status' + (type ? ' ' + type : '');
    };
    const euro = v => typeof v === 'number' ? v.toLocaleString(undefined, { style:'currency', currency:'EUR' }) : '—';
    const pct = v => (v ?? v === 0) ? (Number(v).toLocaleString(undefined, { maximumFractionDigits: 2 }) + '%') : '—';

    // Persist API base in localStorage
    const apiKey = 'optimis_api_base';
    const apiInput = document.getElementById('apiBase');
    const loadApiBase = () => localStorage.getItem(apiKey) || apiInput.value;
    const saveApiBase = (v) => localStorage.setItem(apiKey, v);

    // File name display
    const csvInput = document.getElementById('csvInput');
    const fileName = document.getElementById('fileName');
    csvInput.addEventListener('change', () => {
      fileName.style.display = csvInput.files[0] ? 'inline-block' : 'none';
      fileName.textContent = csvInput.files[0]?.name || '';
    });

    // Settings modal
    const modal = document.getElementById('modal');
    document.getElementById('openSettings').onclick = () => {
      apiInput.value = loadApiBase();
      modal.style.display = 'grid';
    };
    document.getElementById('closeSettings').onclick = () => modal.style.display = 'none';
    document.getElementById('saveSettings').onclick = () => {
      saveApiBase(apiInput.value.trim().replace(/\/$/, ''));
      modal.style.display = 'none';
      showStatus('Paramètres enregistrés', 'ok');
      setTimeout(() => showStatus('Prêt'), 1200);
    };
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

    // Analyze click handler (add credentials if you want this private too)
    document.getElementById('analyzeBtn').onclick = async () => {
      const base = (loadApiBase() || '').replace(/\/$/, '');
      const file = csvInput.files[0];
      const turnover = document.getElementById('turnover').value;
      if (!base) { showStatus('API URL manquante (ouvrir ⚙️)', 'err'); return; }
      if (!file) { showStatus('Veuillez choisir un CSV', 'err'); return; }

      const fd = new FormData();
      fd.append('file', file);
      if (turnover) fd.append('turnover', turnover);

      const btn = document.getElementById('analyzeBtn');
      btn.disabled = true;
      showStatus('Analyse en cours…');

      try {
        const res = await fetch(base + '/analyze/trial-balance', {
          method:'POST',
          body: fd,
          credentials: 'include'   // <— include cookie if you protect this route
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.detail || 'Erreur API');

        document.getElementById('results').style.display = 'block';
        document.getElementById('raw').textContent = JSON.stringify(data, null, 2);

        const k = data.kpi || {};
        document.getElementById('kpi').innerHTML = `
          <div><span>Chiffre d'affaires</span><strong>${euro(k.revenue)}</strong></div>
          <div><span>Marge brute</span><strong>${euro(k.gross_margin)}</strong></div>
          <div><span>EBITDA approx.</span><strong>${euro(k.ebitda_approx)} (${pct(k.ebitda_margin_pct)})</strong></div>
          <div><span>Résultat net</span><strong>${euro(k.net_result)}</strong></div>
          <div><span>BFR</span><strong>${euro(k.working_capital_need)}</strong></div>
          <div><span>Trésorerie</span><strong>${euro(k.cash)}</strong></div>
        `;

        const t = data.tax || {};
        document.getElementById('tax').innerHTML = `
          <div><span>IS estimé</span><strong>${euro(t.corporate_income_tax)}</strong></div>
          <div><span>Contribution sociale (3,3%)</span><strong>${euro(t.social_contribution_on_cit)}</strong></div>
          <div><span>TVA nette</span><strong>${euro(t.vat_balance)}</strong></div>
          <div><span>PME taux 15%</span><strong>${t.eligible_sme_reduced_rate === null ? '—' : (t.eligible_sme_reduced_rate ? 'Oui' : 'Non')}</strong></div>
          <details style="margin-top:6px"><summary>Détails</summary><pre>${JSON.stringify(t.details || {}, null, 2)}</pre></details>
        `;

        const ul = document.getElementById('suggs');
        ul.innerHTML = '';
        (data.suggestions || []).forEach(s => {
          const li = document.createElement('li');
          li.style.marginBottom = '8px';
          li.innerHTML = `<strong>${s.title}</strong><br><span class="hint">${s.rationale}</span>`;
          ul.appendChild(li);
        });

        showStatus('Terminé', 'ok');
      } catch (err) {
        showStatus(err.message || 'Erreur', 'err');
      } finally {
        btn.disabled = false;
      }
    };

    // --- Auth (cookie session) ---
    const loginModal = document.getElementById('loginModal');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const who = document.getElementById('who');

    function openLogin() { loginModal.style.display = 'grid'; }
    function closeLogin() { loginModal.style.display = 'none'; }
    document.getElementById('cancelLogin').onclick = closeLogin;
    loginBtn.onclick = openLogin;

    document.getElementById('doLogin').onclick = async () => {
      const base = (localStorage.getItem('optimis_api_base') || document.getElementById('apiBase')?.value || '').replace(/\/$/, '');
      const company_id = document.getElementById('companyId').value.trim();
      const password = document.getElementById('companyPwd').value;
      if (!base) { showStatus('API URL manquante (ouvrir ⚙️)', 'err'); return; }
      if (!company_id || !password) { showStatus('Identifiant/mot de passe requis', 'err'); return; }
      try {
        const res = await fetch(base + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // cookie
          body: JSON.stringify({ company_id, password })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.detail || 'Login failed');
        who.textContent = `Connecté: ${data.company_id}`;
        who.style.display = 'inline';
        logoutBtn.style.display = 'inline-flex';
        loginBtn.style.display = 'none';
        closeLogin();
        showStatus('Connecté', 'ok');
      } catch (e) {
        showStatus(e.message, 'err');
      }
    };

    logoutBtn.onclick = async () => {
      const base = (localStorage.getItem('optimis_api_base') || document.getElementById('apiBase')?.value || '').replace(/\/$/, '');
      try { await fetch(base + '/auth/logout', { method: 'POST', credentials: 'include' }); }
      finally {
        who.style.display = 'none';
        logoutBtn.style.display = 'none';
        loginBtn.style.display = 'inline-flex';
        showStatus('Déconnecté', 'ok');
      }
    };

    // --- Chat widget (Albert) ---
    const chatBtn = document.getElementById('openChat');
    const chatBox = document.getElementById('chat-box');
    const closeChat = document.getElementById('closeChat');
    const chatLog = document.getElementById('chat-log');
    const chatText = document.getElementById('chatText');
    const sendChat = document.getElementById('sendChat');

    const appendMsg = (text, whoSide) => {
      const div = document.createElement('div');
      div.className = `msg ${whoSide === 'me' ? 'me' : 'bot'}`;
      div.textContent = text;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatBtn.onclick = () => { chatBox.style.display = 'block'; chatText.focus(); };
    closeChat.onclick = () => { chatBox.style.display = 'none'; };

    async function callChatAPI(question) {
      const base = (localStorage.getItem('optimis_api_base') || document.getElementById('apiBase')?.value || '').replace(/\/$/, '');
      if (!base) { appendMsg("Erreur: API non configurée (ouvrir ⚙️)", "bot"); return; }
      try {
        const res = await fetch(base + '/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // send cookie
          body: JSON.stringify({ messages: [
            { role: 'system', content: 'Tu es Albert, un assistant fiscal clair et concis pour les PME françaises. Présente-toi comme Albert lorsque l’utilisateur te salue.' },
            { role: 'user', content: question }
          ]})
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.detail || 'Erreur API');
        appendMsg(data.reply, 'bot');
      } catch (e) {
        appendMsg('Erreur: ' + e.message, 'bot');
      }
    }

    function sendCurrent() {
      const q = chatText.value.trim();
      if (!q) return;
      appendMsg(q, 'me');
      chatText.value = '';
      callChatAPI(q);
    }
    sendChat.onclick = sendCurrent;
    chatText.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendCurrent(); });
  </script>
</body>
</html>
