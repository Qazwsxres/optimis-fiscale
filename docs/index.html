<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Optimis Fiscale</title>

  <!-- FAVICON FIX -->
  <link rel="icon" href="https://placehold.co/32x32/3a71ff/ffffff?text=O" />

  <style>
    :root{--bg:#0b1020;--card:#11172c;--muted:#a3adbf;--line:#243155;
    --accent:#3a71ff;--text:#e6e9ef;--ok:#2ecc71;--err:#e74c3c;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    h1{font-size:22px;margin:0}.sub{color:var(--muted);font-size:14px;margin-top:4px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 12px 28px rgba(0,0,0,.25)}
    .controls{display:grid;gap:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{background:#0e1428;border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .btn,.btn-secondary{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer;border:1px solid transparent}
    .btn{background:var(--accent);color:#fff}.btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:#0e1428;color:var(--text);border-color:var(--line)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .status{font-size:13px;color:var(--muted)}.status.ok{color:var(--ok)}.status.err{color:var(--err)}
    .tiles{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:14px}
    .tile{background:#0e1428;border:1px solid var(--line);border-radius:14px;padding:14px}
    footer{margin-top:16px;color:var(--muted);font-size:13px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:100}
    .modal{width:min(560px,92vw);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .gear{background:#0e1428;border:1px solid var(--line);width:40px;height:40px;display:grid;place-items:center;border-radius:12px;cursor:pointer}

    /* CHAT */
    #chat-btn{position:fixed;right:20px;bottom:20px;z-index:30}
    #chat-btn button{background:#3a71ff;color:#fff;border:0;padding:14px 16px;
      border-radius:999px;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.35)}

    #chat-box{position:fixed;right:20px;bottom:80px;width:min(380px,92vw);
      background:#11172c;border:1px solid #243155;border-radius:16px;
      overflow:hidden;display:none;z-index:30}

    #chat-head{padding:12px 14px;font-weight:700;border-bottom:1px solid #243155;
      display:flex;justify-content:space-between;align-items:center}

    #chat-head img{width:28px;height:28px;border-radius:50%;border:1px solid #243155}

    #chat-log{height:280px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}

    .msg{padding:10px 12px;border-radius:12px;max-width:85%;font-size:14px;line-height:1.35}
    .me{background:#3a71ff;color:#fff;align-self:flex-end}
    .bot{background:#0e1428;border:1px solid #243155;color:#e6e9ef;align-self:flex-start}

    #chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #243155;background:#0e1428}
    #chat-input input{flex:1;background:#0e1428;border:1px solid #33416d;color:#e6e9ef;
      border-radius:10px;padding:10px}

    #chat-input button{background:#3a71ff;color:#fff;border:0;padding:10px 14px;
      border-radius:10px;font-weight:700;cursor:pointer}

    .spinner{display:none;gap:8px;align-items:center}.spinner.active{display:inline-flex}
    .spinner .dot{width:8px;height:8px;border-radius:50%;background:#3a71ff;animation:b 1s infinite}
    .spinner .dot:nth-child(2){animation-delay:.15s}.spinner .dot:nth-child(3){animation-delay:.3s}
    @keyframes b{0%,80%,100%{opacity:.2;transform:scale(.9)}40%{opacity:1;transform:scale(1)}}

    @media print{#chat-btn,#chat-box,header,.controls,.modal-backdrop{display:none!important}
      body{background:#fff;color:#000}.card{border:0;box-shadow:none}}

    @media (max-width:960px){.grid2{grid-template-columns:1fr}}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>Optimis Fiscale</h1>
      <div class="sub">Analyse de balance & estimation fiscale (FR)</div>
    </div>

    <div class="row" id="authbar">
      <div class="gear" id="openSettings" title="Param√®tres (API)">‚öôÔ∏è</div>
      <a class="btn-secondary" href="https://optimis-fiscale-production.up.railway.app/docs" target="_blank">API Docs</a>
      <button id="loginBtn" class="btn-secondary">Se connecter</button>
      <span id="who" class="me" style="display:none"></span>
      <button id="logoutBtn" class="btn-secondary" style="display:none">Se d√©connecter</button>
    </div>
  </header>

  <div class="row" style="margin:8px 0;gap:8px">
    <button class="btn-secondary" id="exportBtn">Exporter (PDF)</button>
    <button class="btn-secondary" id="privacyBtn">Confidentialit√©</button>
    <span class="spinner" id="globalSpin"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>
  </div>
  <div class="card">
    <div class="controls">
      <div class="grid2">
        <div class="field">
          <div><strong>Fichier CSV</strong><br>
            <span class="hint">Colonnes : <code>account,label,debit,credit</code></span>
          </div>
          <div class="row">
            <input id="csvInput" type="file" accept=".csv" style="display:none" />
            <label class="btn-secondary" for="csvInput" style="cursor:pointer;">Choisir un fichier</label>
            <span id="fileName" class="badge" style="display:none"></span>
          </div>
        </div>

        <div class="field">
          <div><strong>Chiffre d'affaires (optionnel)</strong><br>
            <span class="hint">Pour affiner les ratios</span>
          </div>
          <input id="turnover" type="number" step="0.01" placeholder="Ex : 100000" />
        </div>

        <div class="field">
          <div><strong>R√©f√©rentiel d‚Äôaudit</strong><br>
            <span class="hint">Choisir IFRS ou US GAAP</span>
          </div>
          <select id="framework" style="background:#0e1428;border:1px solid var(--line);
            color:var(--text);border-radius:10px;padding:8px 10px;">
            <option value="IFRS" selected>IFRS</option>
            <option value="USGAAP">US GAAP</option>
          </select>
        </div>
      </div>

      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="analyzeBtn" class="btn">Analyser</button>
          <button id="auditBtn" class="btn-secondary">Test Audit</button>
          <button id="optimizeBtn" class="btn-secondary">Optimisation fiscale</button>
        </div>
        <div class="status" id="status">Pr√™t</div>
      </div>
    </div>

    <div id="csvPreview" class="tile" style="display:none">
      <h3>Aper√ßu CSV (10 premi√®res lignes)</h3>
      <div id="csvTableWrap"></div>
    </div>

    <div id="results" style="display:none;margin-top:10px">
      <div class="tiles">
        <div class="tile"><h3>KPIs</h3><div class="kv" id="kpi"></div></div>
        <div class="tile"><h3>Fiscalit√©</h3><div class="kv" id="tax"></div></div>
      </div>

      <div class="tiles" style="margin-top:12px">
        <div class="tile"><h3>Audit ‚Äî R√©sum√©</h3><div class="kv" id="auditSummary"></div></div>
        <div class="tile"><h3>Audit ‚Äî Points relev√©s</h3>
          <ul id="auditIssues" style="margin:0;padding-left:18px"></ul>
        </div>
      </div>

      <div class="tile" style="margin-top:12px">
        <h3>Top comptes (par solde absolu)</h3>
        <div id="auditTop"></div>
      </div>

      <div class="tile" style="margin-top:12px">
        <h3>Optimisation fiscale ‚Äî Recommandations</h3>
        <div id="optimizeOut" style="white-space:pre-wrap"></div>
      </div>
    </div>
  </div>


  <!-- ========================= -->
  <!-- IMPORTATION + DASHBOARD -->
  <!-- ========================= -->
  <div class="grid2" style="margin-top:20px;align-items:flex-start;">

    <!-- LEFT: IMPORTATION -->
    <div class="card">
      <h2>Importation des fichiers</h2>

      <div class="field" style="display:block;">
        <strong>Relev√© bancaire (.csv)</strong>
        <div class="hint" style="font-size:12px;color:#a3adbf;margin-top:4px;">
          Doit contenir : date, libell√©, montant.
        </div>
        <input type="file" id="bankFile" accept=".csv"
          style="margin-top:8px;width:100%;padding:10px;background:#0e1428;
          border:1px solid var(--line);color:#e6e9ef;border-radius:10px;">
        <button class="btn" id="uploadBankBtn" style="margin-top:8px;">Importer relev√©</button>
        <div id="bankUploadStatus" class="status"></div>
      </div>

      <div class="field" style="display:block;margin-top:12px;">
        <strong>Factures de ventes (.csv / .xlsx)</strong>
        <div class="hint" style="font-size:12px;color:#a3adbf;margin-top:4px;">
          Doit contenir : num√©ro, date, √©ch√©ance, client, montant TTC.
        </div>
        <input type="file" id="salesFile" accept=".csv,.xlsx"
          style="margin-top:8px;width:100%;padding:10px;background:#0e1428;border:1px solid var(--line);color:#e6e9ef;border-radius:10px;">
        <button class="btn-secondary" id="uploadSalesBtn" style="margin-top:8px;">Importer ventes</button>
        <div id="salesUploadStatus" class="status"></div>
      </div>

      <div class="field" style="display:block;margin-top:12px;">
        <strong>Factures d‚Äôachats (.csv / .xlsx)</strong>
        <div class="hint" style="font-size:12px;color:#a3adbf;margin-top:4px;">
          Doit contenir : num√©ro, date, √©ch√©ance, fournisseur, montant TTC.
        </div>
        <input type="file" id="purchasesFile" accept=".csv,.xlsx"
          style="margin-top:8px;width:100%;padding:10px;background:#0e1428;border:1px solid var(--line);color:#e6e9ef;border-radius:10px;">
        <button class="btn-secondary" id="uploadPurchasesBtn" style="margin-top:8px;">Importer achats</button>
        <div id="purchasesUploadStatus" class="status"></div>
      </div>
    </div>


    <!-- RIGHT: DASHBOARD -->
    <div class="card">
      <h2>Suivi Tr√©sorerie &amp; Facturation</h2>

      <div id="bankSummary" class="tiles">
        <div class="tile"><h3>Solde bancaire</h3><div id="bankBalance">‚Äî</div></div>
        <div class="tile"><h3>Entr√©es</h3><div id="bankInflows">‚Äî</div></div>
        <div class="tile"><h3>Sorties</h3><div id="bankOutflows">‚Äî</div></div>
      </div>

      <div style="margin-top:16px">
        <h3>√âvolution du solde</h3>
        <canvas id="cashChart" height="100"></canvas>
      </div>


      <!-- üÜï NEW DAILY CASHFLOW CHART -->
      <div style="margin-top:16px">
        <h3>Tr√©sorerie quotidienne (solde journalier)</h3>
        <canvas id="dailyCashChart" height="100"></canvas>
      </div>


      <div class="tiles" style="margin-top:20px">
        <div class="tile">
          <h3>Factures ventes</h3>
          <table id="salesTable" style="width:100%;font-size:13px">
            <thead><tr>
              <th>#</th><th>Date</th><th>√âch√©ance</th><th>Montant</th><th>Statut</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="tile">
          <h3>Factures achats</h3>
          <table id="purchasesTable" style="width:100%;font-size:13px">
            <thead><tr>
              <th>#</th><th>Date</th><th>√âch√©ance</th><th>Montant</th><th>Statut</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="tile" style="margin-top:20px">
        <h3>Alertes fiscales &amp; paiements</h3>
        <ul id="alertsList" style="margin:0;padding-left:18px"></ul>
      </div>

    </div>
  </div>


  <footer>¬© 2025 Optimis Fiscale ‚Äî Les fichiers ne sont jamais stock√©s.</footer>
</div>


<!-- PRIVACY MODAL -->
<div class="modal-backdrop" id="privacyModal" style="display:none">
  <div class="modal">
    <h2>Confidentialit√©</h2>
    <p>Les fichiers sont trait√©s en m√©moire uniquement pendant l‚Äôanalyse. Aucune donn√©e n‚Äôest stock√©e.</p>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="closePrivacy">Fermer</button>
    </div>
  </div>
</div>


<!-- LOGIN MODAL -->
<div class="modal-backdrop" id="loginModal" style="display:none">
  <div class="modal">
    <h2>Connexion</h2>

    <div class="field" style="margin-top:8px;display:block;">
      <label><strong>Identifiant entreprise</strong></label>
      <input id="companyId" type="text" placeholder="ex: demo"
        style="width:100%;margin-top:8px;padding:10px;border-radius:10px;
        background:#0e1428;border:1px solid var(--line);color:#e6e9ef;">
    </div>

    <div class="field" style="margin-top:8px;display:block;">
      <label><strong>Mot de passe</strong></label>
      <input id="companyPwd" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
        style="width:100%;margin-top:8px;padding:10px;border-radius:10px;
        background:#0e1428;border:1px solid var(--line);color:#e6e9ef;">
    </div>

    <div class="row" style="margin-top:12px;justify-content:flex-end;">
      <button class="btn-secondary" id="cancelLogin">Annuler</button>
      <button class="btn" id="doLogin">Connexion</button>
    </div>
  </div>
</div>
<!-- CHAT BUTTON -->
<div id="chat-btn"><button id="openChat">Chat</button></div>

<!-- CHAT BOX -->
<div id="chat-box">
  <div id="chat-head">
    <div class="name" style="display:flex;gap:8px;align-items:center">
      <!-- FIXED AVATAR -->
      <img src="https://placehold.co/56x56/3a71ff/ffffff?text=A" alt="Albert">
      <span>Albert ‚Äî Assistant Fiscal</span>
    </div>
    <button id="closeChat" class="btn-secondary" style="padding:6px 10px;border-radius:10px">Fermer</button>
  </div>
  <div id="chat-log"></div>
  <div id="chat-input">
    <input id="chatText" type="text" placeholder="Posez votre question‚Ä¶" />
    <button id="sendChat">Envoyer</button>
  </div>
</div>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ===============================
   BASIC HELPERS
================================*/
const $ = id => document.getElementById(id);
const euro = v => (typeof v === "number" && isFinite(v))
  ? v.toLocaleString(undefined,{style:'currency',currency:'EUR'})
  : "‚Äî";
const pct = v => (v ?? v === 0)
  ? Number(v).toLocaleString(undefined,{maximumFractionDigits:2}) + "%"
  : "‚Äî";

const DEFAULT_API = "https://optimis-fiscale-production.up.railway.app";

const getApiBase = () => DEFAULT_API;
const setStatus = (msg, cls) => {
  const el = $("status");
  if (!el) return;
  el.textContent = msg;
  el.className = "status" + (cls ? " " + cls : "");
};
const spin = s => $("globalSpin")?.classList.toggle("active", !!s);


/* ===============================
   PRIVACY MODAL
================================*/
$("exportBtn").onclick = () => window.print();
$("privacyBtn").onclick = () => $("privacyModal").style.display = "grid";
$("closePrivacy").onclick = () => $("privacyModal").style.display = "none";
$("privacyModal").addEventListener("click", e => {
  if (e.target === e.currentTarget) e.currentTarget.style.display = "none";
});


/* ===============================
   CSV PREVIEW
================================*/
$("csvInput").addEventListener("change", () => {
  const f = $("csvInput").files?.[0];
  if (!f) { $("csvPreview").style.display = "none"; return; }

  $("fileName").style.display = "inline-block";
  $("fileName").textContent = f.name;

  const r = new FileReader();
  r.onload = () => {
    const text = String(r.result || "");
    const rows = text.trim().split(/\r?\n/).slice(0, 11)
      .map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/));

    if (!rows.length) return;

    $("csvPreview").style.display = "block";
    $("csvTableWrap").innerHTML =
      `<table>
        <thead>${rows[0].map(h => `<th>${h}</th>`).join("")}</thead>
        <tbody>${rows.slice(1)
          .map(r => `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`)
          .join("")}</tbody>
      </table>`;
  };

  r.readAsText(f);
});


/* ===============================
   ANALYZE CSV
================================*/
async function runAnalyze() {
  const base = getApiBase();
  const file = $("csvInput").files?.[0];
  const t = $("turnover").value;

  if (!file) { setStatus("Veuillez choisir un CSV", "err"); return; }

  const fd = new FormData();
  fd.append("file", file);
  if (t) fd.append("turnover", t);

  spin(true);
  setStatus("Analyse en cours‚Ä¶");
  $("analyzeBtn").disabled = true;

  try {
    const r = await fetch(base + "/analyze/trial-balance", {
      method: "POST",
      body: fd,
      credentials: "include"
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d?.detail || "Erreur API");

    $("results").style.display = "block";
    const k = d.kpi || {};
    const tx = d.tax || {};

    $("kpi").innerHTML = `
      <div><span>CA</span><strong>${euro(k.revenue)}</strong></div>
      <div><span>Marge brute</span><strong>${euro(k.gross_margin)}</strong></div>
      <div><span>EBITDA</span><strong>${euro(k.ebitda_approx)} (${pct(k.ebitda_margin_pct)})</strong></div>
      <div><span>R√©sultat net</span><strong>${euro(k.net_result)}</strong></div>
    `;

    $("tax").innerHTML = `
      <div><span>IS estim√©</span><strong>${euro(tx.corporate_income_tax)}</strong></div>
      <div><span>TVA nette</span><strong>${euro(tx.vat_balance)}</strong></div>
    `;

    setStatus("Analyse termin√©e", "ok");
  }
  catch (e) {
    setStatus(e.message || "Erreur", "err");
  }
  finally {
    spin(false);
    $("analyzeBtn").disabled = false;
  }
}
$("analyzeBtn").onclick = runAnalyze;


/* ===============================
   AUDIT
================================*/
async function runAudit() {
  const base = getApiBase();
  const f = $("csvInput").files?.[0];
  const fw = $("framework").value;

  if (!f) { setStatus("Veuillez choisir un CSV", "err"); return; }

  const fd = new FormData();
  fd.append("file", f);
  fd.append("standard", fw);

  spin(true);
  setStatus("Audit en cours‚Ä¶");
  $("auditBtn").disabled = true;

  try {
    const r = await fetch(base + "/audit/test", {
      method: "POST",
      body: fd,
      credentials: "include"
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d?.detail || "Erreur API");

    $("results").style.display = "block";

    const s = d.summary || {};
    const issues = d.issues || [];
    const top = d.top_accounts || [];

    $("auditSummary").innerHTML = `
      <div>Total lignes: <strong>${s.total_rows}</strong></div>
      <div>D√©bits: <strong>${euro(s.total_debit)}</strong></div>
      <div>Cr√©dits: <strong>${euro(s.total_credit)}</strong></div>
      <div>√âcart: <strong>${euro(s.imbalance)}</strong></div>
      <div>R√©f√©rentiel: <strong>${s.framework}</strong></div>
    `;

    $("auditIssues").innerHTML =
      issues.map(i => `<li><strong>[${i.severity.toUpperCase()}]</strong> ${i.message}${i.count ? " ("+i.count+")" : ""}</li>`).join("");

    $("auditTop").innerHTML = `
      <table>
        <thead><tr><th>Compte</th><th>Libell√©</th><th>Solde</th><th>Absolu</th></tr></thead>
        <tbody>${top
          .map(t => `<tr><td>${t.account}</td><td>${t.label}</td><td>${euro(t.balance)}</td><td>${euro(t.abs_balance)}</td></tr>`)
          .join("")}</tbody>
      </table>
    `;

    setStatus("Audit termin√©", "ok");
  }
  catch (e) {
    setStatus(e.message || "Erreur", "err");
  }
  finally {
    spin(false);
    $("auditBtn").disabled = false;
  }
}
$("auditBtn").onclick = runAudit;


/* ===============================
   LOCAL FISCAL OPTIMIZATION
================================*/
function localOptimizeFromKPIs(kpi, tax) {
  const out = [];
  const rev = +kpi.revenue || 0;
  const gm = +kpi.gross_margin || 0;
  const ebitdaPct = +kpi.ebitda_margin_pct || 0;
  const net = +kpi.net_result || 0;
  const vat = +(tax?.vat_balance ?? 0);

  if (rev > 0 && gm / (rev || 1) < 0.30) out.push("Marge brute faible: ren√©gocier achats, optimiser transport, revoir stocks.");
  if (ebitdaPct < 10) out.push("Charge: v√©rifier CAPEX/OPEX, abonnements, assurances.");
  if (net < 0) out.push("D√©ficit: examiner carry-forward / carry-back.");

  out.push("CIR/CII potentiels selon projets R&D.");
  out.push("V√©rifier aides JEI/JEU, exon√©rations r√©gionales.");

  if (vat > 0) out.push("TVA collect√©e > d√©ductible: revoir r√©gime.");
  if (vat < 0) out.push("Cr√©dit de TVA: remboursement mensuel/trimestriel.");

  if (net > 0) out.push("Optimiser r√©mun√©ration vs dividendes.");
  out.push("Provisions clients & stocks √† revoir.");

  return out;
}

async function runOptimize() {
  const base = getApiBase();
  const file = $("csvInput").files?.[0];
  const t = $("turnover")?.value;

  if (!file) { setStatus("Veuillez choisir un CSV", "err"); return; }

  const fd = new FormData();
  fd.append("file", file);
  if (t) fd.append("turnover", t);

  spin(true);
  setStatus("Analyse pour optimisation‚Ä¶");
  $("optimizeBtn").disabled = true;

  try {
    const r = await fetch(base + "/analyze/trial-balance", {
      method: "POST",
      body: fd,
      credentials: "include"
    });

    const analysis = await r.json();
    if (!r.ok) throw new Error(analysis?.detail || "Erreur analyse");

    $("results").style.display = "block";

    const k = analysis.kpi || {};
    const tx = analysis.tax || {};

    const items = localOptimizeFromKPIs(k, tx);

    $("optimizeOut").innerHTML =
      `<ul>${items.map(x => `<li>${x}</li>`).join("")}</ul>
       <div style="margin-top:8px;font-size:12px;color:#a3adbf">
         Note: recommandations indicatives selon votre situation.
       </div>`;

    setStatus("Optimisation (locale) pr√™te", "ok");
  }
  catch (e) {
    setStatus(e.message, "err");
    $("optimizeOut").textContent = "Erreur: " + e.message;
  }
  finally {
    $("optimizeBtn").disabled = false;
    spin(false);
  }
}
$("optimizeBtn").onclick = runOptimize;


/* ===============================
   LOGIN / LOGOUT
================================*/
function openLogin() { $("loginModal").style.display = "grid"; }
function closeLogin() { $("loginModal").style.display = "none"; }

$("loginBtn").onclick = openLogin;
$("cancelLogin").onclick = closeLogin;

$("doLogin").onclick = async () => {
  const base = getApiBase();
  const id = $("companyId").value.trim();
  const pwd = $("companyPwd").value;

  if (!id || !pwd) {
    setStatus("Identifiant et mot de passe requis","err");
    return;
  }

  spin(true);
  setStatus("Connexion‚Ä¶");

  try {
    const r = await fetch(base + "/auth/login", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      credentials: "include",
      body: JSON.stringify({ company_id: id, password: pwd })
    });

    const d = await r.json();
    if (!r.ok) throw new Error(d?.detail || "√âchec connexion");

    closeLogin();

    $("who").style.display = "inline-block";
    $("who").textContent = "Connect√©: " + d.company_id;

    $("loginBtn").style.display = "none";
    $("logoutBtn").style.display = "inline-flex";

    setStatus("Connect√©", "ok");
  }
  catch (e) { setStatus(e.message, "err"); }
  finally { spin(false); }
};

$("logoutBtn").onclick = async () => {
  const base = getApiBase();

  try {
    spin(true);
    await fetch(base + "/auth/logout", {
      method: "POST",
      credentials: "include"
    });
  }
  finally {
    $("who").style.display = "none";
    $("who").textContent = "";

    $("loginBtn").style.display = "inline-flex";
    $("logoutBtn").style.display = "none";

    setStatus("D√©connect√©", "ok");
    spin(false);
  }
};


/* ===============================
   CHAT
================================*/
const chatBox = $("chat-box");
const chatLog = $("chat-log");
const chatText = $("chatText");

const appendMsg = (role, text) => {
  const div = document.createElement("div");
  div.className = "msg " + (role === "user" ? "me" : "bot");
  div.textContent = text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
};

const isLoggedIn = () => $("logoutBtn").style.display !== "none";

$("openChat").onclick = () => {
  if (!isLoggedIn()) {
    setStatus("Veuillez vous connecter pour utiliser le chat", "err");
    openLogin();
    return;
  }
  chatBox.style.display = "block";
  chatText.focus();
};

$("closeChat").onclick = () => chatBox.style.display = "none";
$("sendChat").onclick = sendChat;
chatText.addEventListener("keydown", e => { if (e.key === "Enter") sendChat(); });

async function sendChat() {
  const base = getApiBase();
  const text = chatText.value.trim();
  if (!text) return;

  appendMsg("user", text);
  chatText.value = "";
  setStatus("Albert r√©fl√©chit‚Ä¶");

  try {
    const r = await fetch(base + "/chat", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      credentials:"include",
      body: JSON.stringify({ messages: [{ role:"user", content:text }] })
    });

    if (r.status === 401) {
      setStatus("Session expir√©e. Veuillez vous reconnecter.","err");
      openLogin();
      return;
    }

    const d = await r.json();
    if (!r.ok) throw new Error(d?.detail || "Erreur API");

    appendMsg("assistant", d.reply || "(r√©ponse vide)");
    setStatus("Pr√™t");
  }
  catch (e) {
    appendMsg("assistant", "Erreur: " + (e.message || e));
    setStatus("Erreur chat","err");
  }
}


/* ===============================
   IMPORTATION FILE UPLOADS
================================*/
async function uploadFile(inputId, endpoint, statusId) {
  const file = $(inputId).files?.[0];
  const status = $(statusId);

  if (!file) {
    status.textContent = "Veuillez choisir un fichier";
    status.className = "status err";
    return;
  }

  const fd = new FormData();
  fd.append("file", file);

  try {
    spin(true);
    status.textContent = "Importation en cours‚Ä¶";
    status.className = "status";

    const r = await fetch(getApiBase() + endpoint, {
      method: "POST",
      body: fd,
      credentials: "include"
    });

    if (r.ok) {
      status.textContent = "‚úÖ Importation r√©ussie";
      status.className = "status ok";
      await loadDashboard();
    }
    else {
      const err = await r.text();
      status.textContent = "‚ùå Erreur : " + err.slice(0, 150);
      status.className = "status err";
    }
  }
  catch (e) {
    status.textContent = "‚ùå " + (e.message || "Erreur r√©seau");
    status.className = "status err";
  }
  finally { spin(false); }
}

$("uploadBankBtn").onclick =
  () => uploadFile("bankFile", "/bank/upload", "bankUploadStatus");
$("uploadSalesBtn").onclick =
  () => uploadFile("salesFile", "/invoices/sales", "salesUploadStatus");
$("uploadPurchasesBtn").onclick =
  () => uploadFile("purchasesFile", "/invoices/purchases", "purchasesUploadStatus");


/* ===============================
   DASHBOARD LOADING
================================*/
async function loadDashboard() {
  const apiBase = getApiBase();

  try {
    const [bank, sales, purchases, alerts] = await Promise.all([
      fetch(apiBase + "/bank/summary").then(r => r.json()),
      fetch(apiBase + "/invoices/sales").then(r => r.json()),
      fetch(apiBase + "/invoices/purchases").then(r => r.json()),
      fetch(apiBase + "/alerts").then(r => r.json())
    ]);

    $("bankBalance").textContent = euro(bank.balance ?? 0);
    $("bankInflows").textContent = euro(bank.inflows ?? 0);
    $("bankOutflows").textContent = euro(bank.outflows ?? 0);

    /* BANK SUMMARY CHART */
    const ctx = $("cashChart");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: ["Entr√©es", "Sorties", "Solde"],
        datasets: [{
          data: [
            bank.inflows || 0,
            Math.abs(bank.outflows || 0),
            bank.balance || 0
          ],
          borderColor: "#3a71ff",
          backgroundColor: "rgba(58,113,255,0.2)",
          tension: 0.3
        }]
      },
      options: { plugins:{legend:{display:false}} }
    });

    /* =======================
       üÜï DAILY CASHFLOW CHART
    =======================*/
    const daily = await fetch(apiBase + "/cashflow/daily").then(r => r.json());

    const ctxDaily = $("dailyCashChart");
    new Chart(ctxDaily, {
      type: "line",
      data: {
        labels: daily.map(x => x.date),
        datasets: [{
          label: "Solde journalier",
          data: daily.map(x => x.balance),
          borderColor: "#2ecc71",
          backgroundColor: "rgba(46,204,113,0.2)",
          tension: 0.3
        }]
      },
      options: {
        plugins:{legend:{display:false}},
        scales:{
          x:{ticks:{color:"#a3adbf"}},
          y:{ticks:{color:"#a3adbf"}}
        }
      }
    });

    /* SALES */
    $("salesTable").querySelector("tbody").innerHTML =
      Array.isArray(sales) && sales.length
        ? sales.map(x => `
          <tr>
            <td>${x.number}</td>
            <td>${x.issue_date}</td>
            <td>${x.due_date}</td>
            <td>${euro(x.amount)}</td>
            <td>${x.status}</td>
          </tr>`).join("")
        : `<tr><td colspan="5">Aucune facture</td></tr>`;

    /* PURCHASES */
    $("purchasesTable").querySelector("tbody").innerHTML =
      Array.isArray(purchases) && purchases.length
        ? purchases.map(x => `
          <tr>
            <td>${x.number}</td>
            <td>${x.issue_date}</td>
            <td>${x.due_date}</td>
            <td>${euro(x.amount)}</td>
            <td>${x.status}</td>
          </tr>`).join("")
        : `<tr><td colspan="5">Aucune facture</td></tr>`;

    /* ALERTS */
    $("alertsList").innerHTML =
      Array.isArray(alerts) && alerts.length
        ? alerts.map(a => `<li>${a.message} ‚Äî <span style="color:#a3adbf">${a.due_date}</span></li>`).join("")
        : `<li>Aucune alerte active</li>`;
  }
  catch (e) {
    console.error(e);
    $("alertsList").innerHTML = "<li>Erreur de chargement des donn√©es</li>";
  }
}

document.addEventListener("DOMContentLoaded", loadDashboard);
</script>

</body>
</html>
