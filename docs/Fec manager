<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUMMA - Gestion FEC</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2563eb;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #2563eb;
        }

        .actions {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .form-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }

        label.required::after {
            content: ' *';
            color: #ef4444;
        }

        input, select {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .help-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .entries-table {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 13px;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        tr:hover {
            background: #f9fafb;
        }

        .validated {
            color: #10b981;
            font-weight: 600;
        }

        .not-validated {
            color: #f59e0b;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .alert-info {
            background: #dbeafe;
            border-left: 4px solid #2563eb;
            color: #1e40af;
        }

        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .alert-success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Gestion FEC (Fichier des √âcritures Comptables)</h1>
            <p class="subtitle">Conforme √† l'Article A47 A-1 du Livre des Proc√©dures Fiscales</p>
        </header>

        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è Information Importante</strong><br>
            Ce module g√©n√®re des fichiers FEC conformes √† la r√©glementation fiscale fran√ßaise.<br>
            ‚Ä¢ Encodage: <strong>ISO 8859-1</strong><br>
            ‚Ä¢ S√©parateur: <strong>Pipe (|)</strong><br>
            ‚Ä¢ Intangibilit√©: Les √©critures valid√©es (ValidDate renseign√©e) ne peuvent plus √™tre modifi√©es.<br>
            ‚Ä¢ 18 champs obligatoires dans l'ordre r√©glementaire
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Total √©critures</div>
                <div class="stat-value" id="statTotal">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">√âcritures valid√©es</div>
                <div class="stat-value validated" id="statValidated">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total D√©bit</div>
                <div class="stat-value" id="statDebit">0.00 ‚Ç¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Cr√©dit</div>
                <div class="stat-value" id="statCredit">0.00 ‚Ç¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Balance</div>
                <div class="stat-value" id="statBalance">‚úÖ √âquilibr√©</div>
            </div>
        </div>

        <div class="actions">
            <h3 style="margin-bottom: 15px;">Actions rapides</h3>
            <button class="btn btn-success" onclick="downloadFEC()">üì• Exporter FEC (toutes √©critures)</button>
            <button class="btn btn-success" onclick="downloadFECValidated()">üì• Exporter FEC (valid√©es uniquement)</button>
            <button class="btn btn-primary" onclick="toggleForm()">‚ûï Nouvelle √©criture</button>
            <button class="btn btn-primary" onclick="loadSampleData()">üß™ Charger donn√©es de test</button>
            <button class="btn btn-danger" onclick="clearAllEntries()">üóëÔ∏è Effacer toutes les √©critures</button>
        </div>

        <div class="form-section" id="entryForm" style="display: none;">
            <h3 style="margin-bottom: 15px;">Nouvelle √©criture comptable</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="required">Code Journal</label>
                    <select id="journalCode">
                        <option value="VE">VE - Ventes</option>
                        <option value="AC">AC - Achats</option>
                        <option value="BQ">BQ - Banque</option>
                        <option value="CA">CA - Caisse</option>
                        <option value="OD">OD - Op√©rations Diverses</option>
                        <option value="AN">AN - √Ä-Nouveaux</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="required">Libell√© Journal</label>
                    <input type="text" id="journalLib" placeholder="Ex: Journal des ventes">
                </div>
                <div class="form-group">
                    <label class="required">Date comptabilisation</label>
                    <input type="date" id="ecritureDate">
                    <span class="help-text">Format: AAAAMMJJ</span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="required">Num√©ro de compte (PCG)</label>
                    <input type="text" id="compteNum" placeholder="Ex: 411000">
                    <span class="help-text">Plan Comptable G√©n√©ral</span>
                </div>
                <div class="form-group">
                    <label class="required">Libell√© du compte</label>
                    <input type="text" id="compteLib" placeholder="Ex: Clients">
                </div>
                <div class="form-group">
                    <label>Compte auxiliaire</label>
                    <input type="text" id="compAuxNum" placeholder="Ex: CLI001">
                    <span class="help-text">Client ou fournisseur (optionnel)</span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Libell√© auxiliaire</label>
                    <input type="text" id="compAuxLib" placeholder="Ex: Entreprise ABC">
                </div>
                <div class="form-group">
                    <label class="required">R√©f√©rence pi√®ce</label>
                    <input type="text" id="pieceRef" placeholder="Ex: FA2024001">
                    <span class="help-text">Num√©ro facture ou document</span>
                </div>
                <div class="form-group">
                    <label class="required">Date de la pi√®ce</label>
                    <input type="date" id="pieceDate">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="required">Libell√© de l'√©criture</label>
                    <input type="text" id="ecritureLib" placeholder="Ex: Facture client ABC">
                </div>
                <div class="form-group">
                    <label>D√©bit (‚Ç¨)</label>
                    <input type="number" id="debit" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Cr√©dit (‚Ç¨)</label>
                    <input type="number" id="credit" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Lettrage</label>
                    <input type="text" id="ecritureLet" placeholder="Ex: A">
                    <span class="help-text">Code de lettrage (optionnel)</span>
                </div>
                <div class="form-group">
                    <label>Date de lettrage</label>
                    <input type="date" id="dateLet">
                </div>
                <div class="form-group">
                    <label>Date de validation d√©finitive</label>
                    <input type="date" id="validDate">
                    <span class="help-text">‚ö†Ô∏è Une fois valid√©e, l'√©criture ne peut plus √™tre modifi√©e!</span>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="saveEntry()">üíæ Enregistrer l'√©criture</button>
                <button class="btn btn-danger" onclick="toggleForm()">‚ùå Annuler</button>
            </div>
        </div>

        <div class="entries-table">
            <h3 style="margin-bottom: 15px;">Liste des √©critures comptables</h3>
            <table id="entriesTable">
                <thead>
                    <tr>
                        <th>N¬∞ √âcriture</th>
                        <th>Date</th>
                        <th>Journal</th>
                        <th>Compte</th>
                        <th>Libell√©</th>
                        <th>D√©bit</th>
                        <th>Cr√©dit</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="entriesTableBody">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #999;">Aucune √©criture</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="fec-module.js"></script>
    <script>
        const fecManager = new FECManager();

        // Load and display stats
        function refreshStats() {
            const stats = fecManager.getStats();
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statValidated').textContent = stats.validated;
            document.getElementById('statDebit').textContent = stats.totalDebit + ' ‚Ç¨';
            document.getElementById('statCredit').textContent = stats.totalCredit + ' ‚Ç¨';
            document.getElementById('statBalance').textContent = stats.balanced ? '‚úÖ √âquilibr√©' : '‚ùå D√©s√©quilibr√©';
            
            if (!stats.balanced) {
                document.getElementById('statBalance').style.color = '#ef4444';
            }
        }

        // Load and display entries
        function refreshEntries() {
            const entries = fecManager.getEntries();
            const tbody = document.getElementById('entriesTableBody');
            
            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999;">Aucune √©criture</td></tr>';
                return;
            }

            tbody.innerHTML = entries.map(entry => `
                <tr>
                    <td>${entry.EcritureNum}</td>
                    <td>${formatDate(entry.EcritureDate)}</td>
                    <td>${entry.JournalCode}</td>
                    <td>${entry.CompteNum}</td>
                    <td>${entry.EcritureLib}</td>
                    <td style="text-align: right;">${parseFloat(entry.Debit || 0).toFixed(2)} ‚Ç¨</td>
                    <td style="text-align: right;">${parseFloat(entry.Credit || 0).toFixed(2)} ‚Ç¨</td>
                    <td class="${entry.ValidDate ? 'validated' : 'not-validated'}">
                        ${entry.ValidDate ? '‚úÖ Valid√©e' : '‚è≥ Brouillon'}
                    </td>
                    <td>
                        ${!entry.ValidDate ? `<button class="btn btn-danger" style="padding: 6px 12px; margin: 0;" onclick="deleteEntry('${entry.EcritureNum}')">üóëÔ∏è</button>` : '<span style="color: #999;">Intangible</span>'}
                    </td>
                </tr>
            `).join('');
        }

        // Format date YYYYMMDD to DD/MM/YYYY
        function formatDate(dateStr) {
            if (!dateStr || dateStr.length !== 8) return dateStr;
            return `${dateStr.substr(6,2)}/${dateStr.substr(4,2)}/${dateStr.substr(0,4)}`;
        }

        // Toggle entry form
        function toggleForm() {
            const form = document.getElementById('entryForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            
            if (form.style.display === 'block') {
                // Set default dates to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('ecritureDate').value = today;
                document.getElementById('pieceDate').value = today;
            }
        }

        // Save new entry
        function saveEntry() {
            // Get form values
            const entry = {
                JournalCode: document.getElementById('journalCode').value,
                JournalLib: document.getElementById('journalLib').value,
                EcritureDate: document.getElementById('ecritureDate').value.replace(/-/g, ''),
                CompteNum: document.getElementById('compteNum').value,
                CompteLib: document.getElementById('compteLib').value,
                CompAuxNum: document.getElementById('compAuxNum').value || '',
                CompAuxLib: document.getElementById('compAuxLib').value || '',
                PieceRef: document.getElementById('pieceRef').value,
                PieceDate: document.getElementById('pieceDate').value.replace(/-/g, ''),
                EcritureLib: document.getElementById('ecritureLib').value,
                Debit: document.getElementById('debit').value || '0',
                Credit: document.getElementById('credit').value || '0',
                EcritureLet: document.getElementById('ecritureLet').value || '',
                DateLet: document.getElementById('dateLet').value ? document.getElementById('dateLet').value.replace(/-/g, '') : '',
                ValidDate: document.getElementById('validDate').value ? document.getElementById('validDate').value.replace(/-/g, '') : '',
                Montantdevise: '',
                Idevise: ''
            };

            const result = fecManager.addEntry(entry);
            
            if (result.success) {
                alert('‚úÖ √âcriture enregistr√©e avec succ√®s!\n\nNum√©ro: ' + result.entry.EcritureNum);
                toggleForm();
                refresh();
                
                // Reset form
                document.getElementById('journalLib').value = '';
                document.getElementById('compteNum').value = '';
                document.getElementById('compteLib').value = '';
                document.getElementById('compAuxNum').value = '';
                document.getElementById('compAuxLib').value = '';
                document.getElementById('pieceRef').value = '';
                document.getElementById('ecritureLib').value = '';
                document.getElementById('debit').value = '';
                document.getElementById('credit').value = '';
                document.getElementById('ecritureLet').value = '';
                document.getElementById('dateLet').value = '';
                document.getElementById('validDate').value = '';
            } else {
                alert('‚ùå Erreur:\n\n' + result.error);
            }
        }

        // Delete entry
        function deleteEntry(ecritureNum) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette √©criture?')) {
                return;
            }

            const entries = fecManager.getEntries();
            const filtered = entries.filter(e => e.EcritureNum !== ecritureNum);
            
            if (fecManager.saveEntries(filtered)) {
                alert('‚úÖ √âcriture supprim√©e');
                refresh();
            } else {
                alert('‚ùå Erreur lors de la suppression');
            }
        }

        // Download FEC (all entries)
        function downloadFEC() {
            const year = prompt('Ann√©e fiscale √† exporter (laissez vide pour tout exporter):', new Date().getFullYear());
            fecManager.downloadFEC(year ? parseInt(year) : null, false);
        }

        // Download FEC (validated only)
        function downloadFECValidated() {
            const year = prompt('Ann√©e fiscale √† exporter (laissez vide pour tout exporter):', new Date().getFullYear());
            fecManager.downloadFEC(year ? parseInt(year) : null, true);
        }

        // Load sample data for testing
        function loadSampleData() {
            if (!confirm('Charger des donn√©es de test? (Cela ajoutera des √©critures d\'exemple)')) {
                return;
            }

            const today = new Date();
            const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');

            const samples = [
                {
                    JournalCode: 'VE',
                    JournalLib: 'Journal des ventes',
                    EcritureDate: dateStr,
                    CompteNum: '411000',
                    CompteLib: 'Clients',
                    CompAuxNum: 'CLI001',
                    CompAuxLib: 'Client ABC',
                    PieceRef: 'FA2024001',
                    PieceDate: dateStr,
                    EcritureLib: 'Facture client ABC',
                    Debit: '1200.00',
                    Credit: '0',
                    EcritureLet: '',
                    DateLet: '',
                    ValidDate: dateStr,
                    Montantdevise: '',
                    Idevise: ''
                },
                {
                    JournalCode: 'VE',
                    JournalLib: 'Journal des ventes',
                    EcritureDate: dateStr,
                    CompteNum: '707000',
                    CompteLib: 'Ventes de marchandises',
                    CompAuxNum: '',
                    CompAuxLib: '',
                    PieceRef: 'FA2024001',
                    PieceDate: dateStr,
                    EcritureLib: 'Facture client ABC',
                    Debit: '0',
                    Credit: '1000.00',
                    EcritureLet: '',
                    DateLet: '',
                    ValidDate: dateStr,
                    Montantdevise: '',
                    Idevise: ''
                },
                {
                    JournalCode: 'VE',
                    JournalLib: 'Journal des ventes',
                    EcritureDate: dateStr,
                    CompteNum: '445710',
                    CompteLib: 'TVA collect√©e',
                    CompAuxNum: '',
                    CompAuxLib: '',
                    PieceRef: 'FA2024001',
                    PieceDate: dateStr,
                    EcritureLib: 'TVA sur facture',
                    Debit: '0',
                    Credit: '200.00',
                    EcritureLet: '',
                    DateLet: '',
                    ValidDate: dateStr,
                    Montantdevise: '',
                    Idevise: ''
                }
            ];

            for (const sample of samples) {
                fecManager.addEntry(sample);
            }

            alert('‚úÖ Donn√©es de test charg√©es!\n\n3 √©critures cr√©√©es (une facture compl√®te avec TVA)');
            refresh();
        }

        // Clear all entries
        function clearAllEntries() {
            if (!confirm('‚ö†Ô∏è ATTENTION!\n\nCeci va supprimer TOUTES les √©critures.\n\n√ätes-vous absolument s√ªr?')) {
                return;
            }

            if (fecManager.saveEntries([])) {
                alert('‚úÖ Toutes les √©critures ont √©t√© supprim√©es');
                refresh();
            }
        }

        // Refresh display
        function refresh() {
            refreshStats();
            refreshEntries();
        }

        // Initialize
        refresh();
    </script>
</body>
</html>
